- name: Wait before attempt
  wait_for:
    timeout: 5

- name: Debug credentials
  debug:
    msg:
      - "User: elastic"
      - "Password is set: {{ elastic_password | default('') | length > 0 }}"
      - "URL: {{ local_kbn_url }}"
  no_log: true

- name: Attempt Fleet API call
  uri:
    url: "{{ local_kbn_url }}/api/fleet/settings"
    method: GET
    user: elastic
    password: "{{ elastic_password }}"
    validate_certs: no
    headers: "{{ headers }}"
    status_code: 200
    return_content: yes
    force_basic_auth: yes
  register: fleet_status
  ignore_errors: yes

- name: Display Fleet API call details
  debug:
    msg:
      - "Attempt: {{ current_attempt }}"
      - "URL: {{ fleet_status.url }}"
      - "Status: {{ fleet_status.status | default('N/A') }}"
      - "Status Message: {{ fleet_status.msg | default('N/A') }}"
      - "Response Headers: {{ fleet_status.headers | default({}) | to_nice_json }}"
      - "Response Content: {{ fleet_status.content | default('N/A') | to_nice_json }}"

- name: Set success flag if API call succeeded
  set_fact:
    api_success: "{{ fleet_status.status is defined and fleet_status.status == 200 }}"

- name: Debug credentials
  debug:
    msg:
      - "User: elastic"
      - "Password is set: {{ elastic_password | default('') | length > 0 }}"
      - "Password is set: {{ elastic_password }}"
      - "URL: {{ local_kbn_url }}"
  no_log: true

- name: Attempt Fleet API call
  uri:
    url: "{{ local_kbn_url }}/api/fleet/settings"
    method: GET
    user: elastic
    password: "{{ elastic_password }}"
    validate_certs: no
    headers: "{{ headers }}"
    status_code: 200
    return_content: yes
    force_basic_auth: yes
  register: fleet_status
  ignore_errors: yes

- name: Display Fleet API call details
  debug:
    msg:
      - "Attempt: {{ attempt_counter }}"
      - "URL: {{ fleet_status.url }}"
      - "Status: {{ fleet_status.status | default('N/A') }}"
      - "Status Message: {{ fleet_status.msg | default('N/A') }}"
      - "Response Headers: {{ fleet_status.headers | default({}) | to_nice_json }}"
      - "Response Content: {{ fleet_status.content | default('N/A') | to_nice_json }}"

- name: Increment attempt counter
  set_fact:
    attempt_counter: "{{ attempt_counter | int + 1 }}"

- name: Check if max retries reached
  fail:
    msg: "Max retries reached. Fleet API is not ready."
  when: attempt_counter | int > max_retries

- name: Wait before next attempt
  wait_for:
    timeout: "{{ delay_seconds }}"
  when: fleet_status.status is not defined or fleet_status.status != 200